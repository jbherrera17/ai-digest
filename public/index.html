<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI News Digest Generator</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
        }
        /* --- Navigation Bar --- */
        .navbar {
            background: #1a1a2e;
            padding: 0 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 56px;
        }
        .navbar-brand {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
            text-decoration: none;
            font-weight: 700;
            font-size: 1.1rem;
        }
        .navbar-brand svg {
            width: 28px;
            height: 28px;
        }
        .navbar-links {
            display: flex;
            gap: 8px;
        }
        .navbar-link {
            padding: 8px 16px;
            border-radius: 6px;
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        .navbar-link:hover {
            color: white;
            background: rgba(255,255,255,0.1);
        }
        .navbar-link.active {
            color: white;
            background: #667eea;
        }
        /* --- Top Bar --- */
        .topbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 24px 0; text-align: center;
        }
        .topbar h1 { font-size: 1.8rem; font-weight: 700; }
        .topbar p { font-size: 0.95rem; opacity: 0.85; margin-top: 4px; }
        /* --- Layout --- */
        .layout {
            max-width: 1400px; margin: 0 auto; padding: 24px;
            display: grid; grid-template-columns: 320px 1fr; gap: 24px;
        }
        @media (max-width: 900px) {
            .layout { grid-template-columns: 1fr; }
        }
        /* --- Sidebar --- */
        .sidebar { display: flex; flex-direction: column; gap: 16px; }
        .card {
            background: white; border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08); padding: 20px;
        }
        .card h2 {
            font-size: 0.85rem; font-weight: 600; color: #667eea;
            text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px;
        }
        select, input[type="text"] {
            width: 100%; padding: 10px 12px; border: 1.5px solid #e0e0e0;
            border-radius: 8px; font-size: 0.9rem; font-family: inherit;
            transition: border-color 0.2s; background: white;
        }
        select:focus, input[type="text"]:focus { outline: none; border-color: #667eea; }
        /* --- Source Picker --- */
        .source-toolbar {
            display: flex; gap: 6px; align-items: center; margin-bottom: 10px; flex-wrap: wrap;
        }
        .source-toolbar .search-wrap {
            flex: 1; min-width: 120px; position: relative;
        }
        .source-toolbar .search-wrap input {
            padding-left: 32px; font-size: 0.85rem;
        }
        .source-toolbar .search-wrap::before {
            content: '\1F50D'; position: absolute; left: 10px; top: 50%;
            transform: translateY(-50%); color: #aaa; font-size: 1rem;
        }
        .pill-btn {
            padding: 6px 12px; border: 1.5px solid #e0e0e0; border-radius: 20px;
            background: white; font-size: 0.75rem; font-weight: 600; cursor: pointer;
            color: #555; transition: all 0.15s; white-space: nowrap;
        }
        .pill-btn:hover { border-color: #667eea; color: #667eea; }
        .source-count {
            font-size: 0.8rem; color: #888; text-align: right; margin-bottom: 8px;
        }
        .category-group { margin-bottom: 6px; }
        .category-toggle {
            display: flex; align-items: center; justify-content: space-between;
            padding: 8px 10px; background: #f8f9fa; border-radius: 8px;
            cursor: pointer; user-select: none; border: none; width: 100%;
            font-family: inherit; text-align: left; transition: background 0.15s;
        }
        .category-toggle:hover { background: #eef0f4; }
        .category-toggle .cat-label {
            font-size: 0.8rem; font-weight: 600; color: #444;
            display: flex; align-items: center; gap: 6px;
        }
        .category-toggle .cat-count {
            font-size: 0.7rem; background: #667eea; color: white;
            padding: 1px 7px; border-radius: 10px; font-weight: 600;
        }
        .category-toggle .cat-check {
            font-size: 0.7rem; color: #667eea; font-weight: 600; cursor: pointer;
        }
        .category-toggle .arrow {
            font-size: 0.65rem; color: #999; transition: transform 0.2s;
        }
        .category-group.open .arrow { transform: rotate(90deg); }
        .category-feeds {
            display: none; padding: 4px 0 4px 8px;
        }
        .category-group.open .category-feeds { display: block; }
        .feed-item {
            display: flex; align-items: center; gap: 8px;
            padding: 5px 8px; border-radius: 6px; cursor: pointer;
            transition: background 0.15s;
        }
        .feed-item:hover { background: #f0f2f5; }
        .feed-item input { width: 15px; height: 15px; cursor: pointer; accent-color: #667eea; }
        .feed-item span { font-size: 0.8rem; color: #444; }
        .feed-item .feed-type {
            font-size: 0.6rem; font-weight: 600; padding: 1px 5px;
            border-radius: 4px; text-transform: uppercase;
        }
        .feed-type-blog { background: #dbeafe; color: #1d4ed8; }
        .feed-type-newsletter { background: #fef3c7; color: #92400e; }
        .feed-type-news { background: #d1fae5; color: #065f46; }
        /* --- Generate Button --- */
        .btn-generate {
            width: 100%; padding: 14px; border: none; border-radius: 10px;
            font-size: 1rem; font-weight: 700; cursor: pointer;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; transition: all 0.2s; font-family: inherit;
        }
        .btn-generate:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(102,126,234,0.4);
        }
        .btn-generate:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
        /* --- Progress --- */
        .progress-container { display: none; margin-top: 12px; }
        .progress-bar {
            height: 6px; background: #e0e0e0; border-radius: 3px; overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%; width: 0%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
        }
        .progress-text { text-align: center; margin-top: 6px; color: #888; font-size: 0.8rem; }
        /* --- Main Content --- */
        .main { min-width: 0; }
        .results { display: none; }
        .results.show { display: block; }
        .placeholder-msg {
            text-align: center; padding: 80px 20px; color: #aaa;
        }
        .placeholder-msg h3 { font-size: 1.2rem; margin-bottom: 8px; color: #bbb; }
        .placeholder-msg p { font-size: 0.9rem; }
        /* --- Stats --- */
        .stats {
            display: grid; grid-template-columns: repeat(4, 1fr);
            gap: 12px; margin-bottom: 20px;
        }
        @media (max-width: 700px) { .stats { grid-template-columns: repeat(2, 1fr); } }
        .stat-box {
            background: white; padding: 16px; border-radius: 10px; text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06); border-top: 3px solid #667eea;
        }
        .stat-box .number { font-size: 1.8rem; font-weight: 700; color: #333; }
        .stat-box .label { font-size: 0.75rem; color: #888; text-transform: uppercase; letter-spacing: 0.3px; }
        /* --- Tabs --- */
        .tabs {
            display: flex; gap: 2px; background: #e9ecef;
            border-radius: 10px; padding: 3px; margin-bottom: 20px;
        }
        .tab {
            flex: 1; padding: 10px 12px; border: none; border-radius: 8px;
            cursor: pointer; font-weight: 600; color: #666; font-size: 0.85rem;
            background: transparent; transition: all 0.2s; font-family: inherit;
        }
        .tab.active { background: white; color: #667eea; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
        .tab:hover:not(.active) { color: #333; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .section-title {
            font-size: 1.1rem; font-weight: 600; color: #333;
            margin: 0 0 16px 0; padding-bottom: 10px; border-bottom: 2px solid #667eea;
        }
        /* --- Articles --- */
        .article {
            padding: 20px; background: white; border-radius: 12px;
            margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            transition: box-shadow 0.2s;
        }
        .article:hover { box-shadow: 0 3px 12px rgba(0,0,0,0.1); }
        .article-header {
            display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;
        }
        .article h3 { font-size: 1.05rem; color: #333; margin-bottom: 6px; line-height: 1.4; }
        .article h3 a { color: #333; text-decoration: none; }
        .article h3 a:hover { color: #667eea; }
        .article-meta {
            display: flex; gap: 10px; font-size: 0.8rem; color: #888; margin-bottom: 10px;
            flex-wrap: wrap; align-items: center;
        }
        .article-meta .source { font-weight: 600; color: #667eea; }
        .article-meta .topic {
            background: #f0f4ff; color: #667eea; padding: 2px 10px;
            border-radius: 20px; font-weight: 500;
        }
        .smb-score { color: #f59e0b; font-size: 0.85rem; white-space: nowrap; }
        .article p { color: #555; line-height: 1.6; font-size: 0.9rem; }
        /* --- Key Bullets --- */
        .key-bullets { margin: 8px 0; padding-left: 18px; }
        .key-bullets li { color: #444; line-height: 1.6; font-size: 0.88rem; margin-bottom: 4px; }
        /* --- What it Means --- */
        .what-it-means {
            margin: 12px 0; padding: 14px 16px; background: #f8faff;
            border-radius: 8px; border-left: 3px solid #667eea;
        }
        .what-it-means h4 { font-size: 0.9rem; color: #667eea; margin-bottom: 10px; font-weight: 700; }
        .what-it-means .impact-sub { margin-bottom: 8px; }
        .what-it-means .impact-sub strong { font-size: 0.82rem; color: #333; }
        .what-it-means .impact-sub p { font-size: 0.82rem; color: #666; margin-top: 2px; line-height: 1.5; }
        /* --- Viral / Trending --- */
        .viral-badge {
            display: inline-block; background: #ef4444; color: white;
            font-size: 0.65rem; font-weight: 700; padding: 2px 8px;
            border-radius: 12px; margin-left: 8px; vertical-align: middle;
            text-transform: uppercase; letter-spacing: 0.3px;
        }
        /* --- Content Suggestions --- */
        .content-suggestions {
            margin: 12px 0; padding: 14px 16px; background: #fffbeb;
            border-radius: 8px; border-left: 3px solid #f59e0b;
        }
        .content-suggestions h4 { font-size: 0.85rem; color: #92400e; margin-bottom: 8px; font-weight: 700; }
        .content-suggestions ul { padding-left: 18px; }
        .content-suggestions li { font-size: 0.82rem; color: #78350f; line-height: 1.5; margin-bottom: 3px; }
        /* --- Topic Sections --- */
        .topic-section { margin-bottom: 24px; }
        .topic-header {
            font-size: 0.9rem; font-weight: 600; color: #667eea;
            margin-bottom: 8px; padding: 10px 14px;
            background: #f0f4ff; border-radius: 8px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .topic-header .count { font-size: 0.75rem; color: #999; }
        .quick-hit {
            padding: 10px 14px; background: white; border-left: 3px solid #667eea;
            margin-bottom: 6px; border-radius: 0 8px 8px 0;
            box-shadow: 0 1px 2px rgba(0,0,0,0.04);
        }
        .quick-hit a { color: #333; text-decoration: none; font-weight: 500; font-size: 0.9rem; }
        .quick-hit a:hover { color: #667eea; }
        .quick-hit .meta { font-size: 0.75rem; color: #999; margin-top: 3px; }
        /* --- Export --- */
        .export-bar {
            display: flex; gap: 8px; flex-wrap: wrap;
        }
        .btn-export {
            padding: 8px 16px; border: 1.5px solid #e0e0e0; border-radius: 8px;
            background: white; font-size: 0.8rem; font-weight: 600; cursor: pointer;
            color: #555; transition: all 0.15s; font-family: inherit;
        }
        .btn-export:hover { border-color: #667eea; color: #667eea; }
        /* --- Footer --- */
        .footer { text-align: center; padding: 24px; color: #bbb; font-size: 0.8rem; }
    </style>
</head>
<body>
    <nav class="navbar">
        <a href="/" class="navbar-brand">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M4 11a9 9 0 0 1 9 9"></path>
                <path d="M4 4a16 16 0 0 1 16 16"></path>
                <circle cx="5" cy="19" r="1"></circle>
            </svg>
            AIDigest
        </a>
        <div class="navbar-links">
            <a href="/" class="navbar-link active">Digest</a>
            <a href="/admin" class="navbar-link">Admin</a>
        </div>
    </nav>

    <div class="topbar">
        <h1>AI News Digest Generator</h1>
        <p>50+ AI sources â€” news, newsletters, and company blogs</p>
    </div>

    <div class="layout">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="card">
                <h2>Time Range</h2>
                <select id="days">
                    <option value="1">Past 24 hours</option>
                    <option value="3">Past 3 days</option>
                    <option value="7" selected>Past 7 days</option>
                    <option value="14">Past 2 weeks</option>
                </select>
            </div>

            <div class="card" style="flex:1; overflow-y: auto; max-height: 55vh;">
                <h2>Sources</h2>
                <div class="source-toolbar">
                    <div class="search-wrap">
                        <input type="text" id="feedSearch" placeholder="Filter sources..." oninput="filterFeeds()">
                    </div>
                    <button class="pill-btn" onclick="selectAllFeeds()">All</button>
                    <button class="pill-btn" onclick="deselectAllFeeds()">None</button>
                </div>
                <div class="source-count" id="sourceCount"></div>
                <div id="feedsContainer"></div>
            </div>

            <div class="card">
                <button class="btn-generate" id="generateBtn" onclick="generateDigest()">
                    Generate Digest
                </button>
                <div class="progress-container" id="progressContainer">
                    <div class="progress-bar">
                        <div class="progress-bar-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">Starting...</div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main">
            <div id="placeholder" class="card placeholder-msg">
                <h3>Your digest will appear here</h3>
                <p>Select sources and time range, then click Generate Digest.</p>
            </div>

            <div class="results" id="resultsCard">
                <div class="stats" id="stats"></div>

                <div class="card" style="margin-bottom: 16px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                        <div class="tabs" style="margin-bottom:0; flex:1; max-width: 500px;">
                            <button class="tab active" onclick="showTab('top', this)">Top Stories</button>
                            <button class="tab" onclick="showTab('smb', this)">SMB Spotlight</button>
                            <button class="tab" onclick="showTab('topics', this)">By Topic</button>
                            <button class="tab" onclick="showTab('all', this)">All</button>
                        </div>
                        <div class="export-bar">
                            <button class="btn-export" onclick="exportMarkdown()">Export .md</button>
                            <button class="btn-export" onclick="copyToClipboard()">Copy</button>
                        </div>
                    </div>

                    <div id="topStoriesTab" class="tab-content active">
                        <div class="section-title">Top Stories This Week</div>
                        <div id="topStories"></div>
                    </div>
                    <div id="smbTab" class="tab-content">
                        <div class="section-title">SMB AI Spotlight</div>
                        <div id="smbSpotlight"></div>
                    </div>
                    <div id="topicsTab" class="tab-content">
                        <div class="section-title">Quick Hits by Topic</div>
                        <div id="byTopic"></div>
                    </div>
                    <div id="allTab" class="tab-content">
                        <div class="section-title">All Articles</div>
                        <div id="allArticles"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">Built for Synergi AI / Insight Driven Business</div>

    <script>
        let digestData = null;
        let allFeeds = {};

        // --- Source category display order and labels ---
        const CATEGORY_ORDER = [
            { key: 'Tech News,Consumer Tech,Tech Culture,Deep Tech,Business Tech,AI News', label: 'News Outlets' },
            { key: 'Enterprise AI', label: 'Enterprise AI' },
            { key: 'Company News,Company Blog', label: 'Company Blogs' },
            { key: 'AI Platform', label: 'AI Platforms' },
            { key: 'AI Infrastructure', label: 'AI Infrastructure' },
            { key: 'Cloud AI', label: 'Cloud Platforms' },
            { key: 'Productivity AI', label: 'Productivity AI' },
            { key: 'Newsletter', label: 'Newsletters' },
            { key: 'Substack', label: 'Substack Subscriptions' },
            { key: 'Medium', label: 'Medium Follows' },
            { key: 'Research & Policy', label: 'Research & Policy' },
        ];

        function getFeedType(feed) {
            if (feed.type === 'newsletter') return 'newsletter';
            if (feed.type === 'blog') return 'blog';
            return 'news';
        }

        function getFeedTypeLabel(type) {
            if (type === 'blog') return '<span class="feed-type feed-type-blog">Blog</span>';
            if (type === 'newsletter') return '<span class="feed-type feed-type-newsletter">NL</span>';
            return '';
        }

        // Group feeds into display categories
        function groupFeeds(feeds) {
            const groups = [];
            const assigned = new Set();

            for (const catDef of CATEGORY_ORDER) {
                const cats = catDef.key.split(',');
                const items = [];
                for (const [name, config] of Object.entries(feeds)) {
                    if (cats.includes(config.category) && !assigned.has(name)) {
                        items.push({ name, config });
                        assigned.add(name);
                    }
                }
                if (items.length > 0) {
                    groups.push({ label: catDef.label, items });
                }
            }

            // Catch any uncategorized
            const remaining = [];
            for (const [name, config] of Object.entries(feeds)) {
                if (!assigned.has(name)) {
                    remaining.push({ name, config });
                    assigned.add(name);
                }
            }
            if (remaining.length > 0) {
                groups.push({ label: 'Other', items: remaining });
            }

            return groups;
        }

        async function loadFeeds() {
            try {
                const resp = await fetch('/api/feeds');
                allFeeds = await resp.json();
                renderFeeds();
            } catch (e) {
                console.error('Failed to load feeds:', e);
            }
        }

        function renderFeeds(filter = '') {
            const container = document.getElementById('feedsContainer');
            const groups = groupFeeds(allFeeds);
            const lowerFilter = filter.toLowerCase();

            let html = '';
            let totalShown = 0;
            let totalChecked = 0;

            for (const group of groups) {
                const filtered = group.items.filter(f =>
                    !lowerFilter || f.name.toLowerCase().includes(lowerFilter) ||
                    f.config.category.toLowerCase().includes(lowerFilter)
                );
                if (filtered.length === 0) continue;

                const groupId = group.label.replace(/\s+/g, '_');
                totalShown += filtered.length;

                html += `<div class="category-group open" id="grp_${groupId}">
                    <button class="category-toggle" onclick="toggleGroup('${groupId}')">
                        <span class="cat-label">
                            <span class="arrow">&#9654;</span>
                            ${group.label}
                            <span class="cat-count">${filtered.length}</span>
                        </span>
                        <span class="cat-check" onclick="event.stopPropagation(); toggleCategory('${groupId}')">toggle</span>
                    </button>
                    <div class="category-feeds">`;

                for (const f of filtered) {
                    const type = getFeedType(f.config);
                    html += `<label class="feed-item">
                        <input type="checkbox" name="feed" value="${f.name}" checked>
                        <span>${f.name}</span>
                        ${getFeedTypeLabel(type)}
                    </label>`;
                }

                html += `</div></div>`;
            }

            container.innerHTML = html;
            updateSourceCount();
        }

        function updateSourceCount() {
            const all = document.querySelectorAll('input[name="feed"]');
            const checked = document.querySelectorAll('input[name="feed"]:checked');
            document.getElementById('sourceCount').textContent =
                `${checked.length} of ${all.length} sources selected`;
        }

        // Attach change listener for live count updates
        document.addEventListener('change', (e) => {
            if (e.target.name === 'feed') updateSourceCount();
        });

        function toggleGroup(groupId) {
            document.getElementById('grp_' + groupId).classList.toggle('open');
        }

        function toggleCategory(groupId) {
            const group = document.getElementById('grp_' + groupId);
            const checks = group.querySelectorAll('input[name="feed"]');
            const allChecked = Array.from(checks).every(c => c.checked);
            checks.forEach(c => c.checked = !allChecked);
            updateSourceCount();
        }

        function filterFeeds() {
            const q = document.getElementById('feedSearch').value;
            renderFeeds(q);
        }

        function selectAllFeeds() {
            document.querySelectorAll('input[name="feed"]').forEach(cb => cb.checked = true);
            updateSourceCount();
        }
        function deselectAllFeeds() {
            document.querySelectorAll('input[name="feed"]').forEach(cb => cb.checked = false);
            updateSourceCount();
        }
        function getSelectedFeeds() {
            return Array.from(document.querySelectorAll('input[name="feed"]:checked')).map(cb => cb.value);
        }

        async function generateDigest() {
            const btn = document.getElementById('generateBtn');
            const progressContainer = document.getElementById('progressContainer');
            const resultsCard = document.getElementById('resultsCard');
            const placeholder = document.getElementById('placeholder');

            const feeds = getSelectedFeeds();
            if (feeds.length === 0) {
                alert('Please select at least one feed source.');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Generating...';
            progressContainer.style.display = 'block';
            resultsCard.classList.remove('show');
            placeholder.style.display = 'none';

            const days = parseInt(document.getElementById('days').value);
            let completed = 0;
            const total = feeds.length;
            let allArticles = [];
            let errors = [];

            function updateProgress(feedName) {
                completed++;
                const pct = Math.round((completed / total) * 100);
                document.getElementById('progressFill').style.width = pct + '%';
                document.getElementById('progressText').textContent =
                    `Fetched ${completed}/${total}: ${feedName}`;
            }

            const promises = feeds.map(name =>
                fetch('/api/fetch-feed', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, days })
                })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        allArticles.push(...data.articles);
                    } else if (data.error) {
                        errors.push({ source: name, error: data.error });
                    }
                    updateProgress(name);
                })
                .catch(err => {
                    errors.push({ source: name, error: err.message });
                    updateProgress(name);
                })
            );

            await Promise.all(promises);

            allArticles.sort((a, b) => b.published.localeCompare(a.published));

            const byTopic = {};
            allArticles.forEach(a => {
                if (!byTopic[a.topic]) byTopic[a.topic] = [];
                byTopic[a.topic].push(a);
            });

            const topStories = [...allArticles]
                .sort((a, b) => a.priority - b.priority || b.published.localeCompare(a.published))
                .slice(0, 5);

            const smbSpotlight = allArticles
                .filter(a => a.smb_score >= 4)
                .sort((a, b) => b.smb_score - a.smb_score)
                .slice(0, 3);

            digestData = {
                stats: {
                    total_articles: allArticles.length,
                    sources_checked: total,
                    sources_with_errors: errors.length,
                    errors,
                    generated_at: new Date().toISOString()
                },
                top_stories: topStories,
                smb_spotlight: smbSpotlight,
                by_topic: byTopic,
                all_articles: allArticles
            };

            document.getElementById('progressFill').style.width = '100%';
            document.getElementById('progressText').textContent = 'Complete!';

            setTimeout(() => {
                displayResults(digestData);
                progressContainer.style.display = 'none';
                resultsCard.classList.add('show');
                btn.disabled = false;
                btn.textContent = 'Generate Digest';
            }, 400);
        }

        function renderArticleCard(a) {
            return `
                <div class="article">
                    <div class="article-header">
                        <h3><a href="${a.link}" target="_blank">${a.title}</a>${a.viral_score >= 4 ? '<span class="viral-badge">Trending</span>' : ''}</h3>
                        <span class="smb-score">${'\u2605'.repeat(a.smb_score || 0)}${'\u2606'.repeat(10 - (a.smb_score || 0))}</span>
                    </div>
                    <div class="article-meta">
                        <span class="source">${a.source}</span>
                        <span>${a.published_display}</span>
                        <span class="topic">${a.topic}</span>
                    </div>
                    ${a.key_bullets && a.key_bullets.length > 0 ? `
                        <ul class="key-bullets">
                            ${a.key_bullets.map(b => `<li>${b}</li>`).join('')}
                        </ul>
                    ` : `<p>${a.summary}</p>`}
                    ${a.impact ? `
                        <div class="what-it-means">
                            <h4>What it Means</h4>
                            <div class="impact-sub"><strong>General Impact:</strong><p>${a.impact.general_impact}</p></div>
                            <div class="impact-sub"><strong>Impact to SMBs:</strong><p>${a.impact.smb_impact}</p></div>
                        </div>
                    ` : ''}
                    ${a.content_suggestions ? `
                        <div class="content-suggestions">
                            <h4>Content Ideas (Trending Topic)</h4>
                            <ul>${a.content_suggestions.map(s => `<li>${s}</li>`).join('')}</ul>
                        </div>
                    ` : ''}
                </div>`;
        }

        function displayResults(data) {
            document.getElementById('stats').innerHTML = `
                <div class="stat-box"><div class="number">${data.stats.total_articles}</div><div class="label">Articles</div></div>
                <div class="stat-box"><div class="number">${data.stats.sources_checked}</div><div class="label">Sources</div></div>
                <div class="stat-box"><div class="number">${data.top_stories.length}</div><div class="label">Top Stories</div></div>
                <div class="stat-box"><div class="number">${data.smb_spotlight.length}</div><div class="label">SMB Relevant</div></div>
            `;

            document.getElementById('topStories').innerHTML = data.top_stories.map(a => renderArticleCard(a)).join('');

            document.getElementById('smbSpotlight').innerHTML = data.smb_spotlight.length > 0
                ? data.smb_spotlight.map(a => renderArticleCard(a)).join('')
                : '<p style="color:#999;padding:20px;text-align:center;">No highly SMB-relevant articles found this period.</p>';

            const topicOrder = ['Big Tech', 'Funding & Deals', 'Product News', 'Research', 'Policy & Regulation', 'SMB Focus', 'General AI News'];
            document.getElementById('byTopic').innerHTML = topicOrder
                .filter(t => data.by_topic[t] && data.by_topic[t].length > 0)
                .map(t => `
                    <div class="topic-section">
                        <div class="topic-header">
                            <span>${t}</span>
                            <span class="count">${data.by_topic[t].length} articles</span>
                        </div>
                        ${data.by_topic[t].slice(0, 5).map(a => renderArticleCard(a)).join('')}
                    </div>
                `).join('');

            document.getElementById('allArticles').innerHTML = data.all_articles.map(a => renderArticleCard(a)).join('');
        }

        function showTab(tab, el) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            const tabMap = { top: 'topStoriesTab', smb: 'smbTab', topics: 'topicsTab', all: 'allTab' };
            document.getElementById(tabMap[tab]).classList.add('active');
        }

        async function exportMarkdown() {
            if (!digestData) return;
            const response = await fetch('/api/export', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    top_stories: digestData.top_stories,
                    smb_spotlight: digestData.smb_spotlight,
                    all_articles: digestData.all_articles
                })
            });
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ai_digest.md';
            a.click();
        }

        function copyToClipboard() {
            if (!digestData) return;
            let text = "AI NEWS DIGEST\n\nTOP STORIES\n" + "-".repeat(40) + "\n\n";
            digestData.top_stories.forEach((a, i) => {
                text += `${i + 1}. ${a.title}\n   ${a.source} | ${a.published_display}\n   ${a.link}\n\n`;
            });
            navigator.clipboard.writeText(text).then(() => alert('Digest copied to clipboard!'));
        }

        document.addEventListener('DOMContentLoaded', loadFeeds);
    </script>
</body>
</html>
